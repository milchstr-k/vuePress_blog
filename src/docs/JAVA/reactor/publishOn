---
icon: pen-to-square
date: 2023-11-16 15:37
category:
  - Reactor
tag:
  - publishOnã€subscribeOn
---

# Reactor

> ğŸ“Œ **å…³é”®è¯ï¼š** javaã€reactor

## publishOnã€subscribeOn

Schedulersç±»ä¼¼Executor,æ˜¯Reactorçš„çº¿ç¨‹è°ƒåº¦æ¥å£ã€‚æä¾›ä»¥ä¸‹å‡ ç§çº¿ç¨‹æ‰§è¡Œç¯å¢ƒï¼š

å½“å‰çº¿ç¨‹ï¼ˆSchedulers.immediate()ï¼‰ï¼›
å¯é‡ç”¨çš„å•çº¿ç¨‹ï¼ˆSchedulers.single()ï¼‰ã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹æ‰€æœ‰è°ƒç”¨è€…éƒ½æä¾›åŒä¸€ä¸ªçº¿ç¨‹æ¥ä½¿ç”¨ï¼Œ ç›´åˆ°è¯¥è°ƒåº¦å™¨è¢«åºŸå¼ƒã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ç‹¬å çš„çº¿ç¨‹ï¼Œè¯·ä½¿ç”¨Schedulers.newSingle()ï¼›
å¼¹æ€§çº¿ç¨‹æ± ï¼ˆSchedulers.elastic()ï¼‰ã€‚å®ƒæ ¹æ®éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œé‡ç”¨ç©ºé—²çº¿ç¨‹ã€‚çº¿ç¨‹æ± å¦‚æœç©ºé—²æ—¶é—´è¿‡é•¿ ï¼ˆé»˜è®¤ä¸º 60sï¼‰å°±ä¼šè¢«åºŸå¼ƒã€‚å¯¹äº I/O é˜»å¡çš„åœºæ™¯æ¯”è¾ƒé€‚ç”¨ã€‚Schedulers.elastic()èƒ½å¤Ÿæ–¹ä¾¿åœ°ç»™ä¸€ä¸ªé˜»å¡ çš„ä»»åŠ¡åˆ†é…å®ƒè‡ªå·±çš„çº¿ç¨‹ï¼Œä»è€Œä¸ä¼šå¦¨ç¢å…¶ä»–ä»»åŠ¡å’Œèµ„æºï¼›
å›ºå®šå¤§å°çº¿ç¨‹æ± ï¼ˆSchedulers.parallel()ï¼‰ï¼Œæ‰€åˆ›å»ºçº¿ç¨‹æ± çš„å¤§å°ä¸CPUä¸ªæ•°ç­‰åŒï¼›
è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆSchedulers.fromExecutorService(ExecutorService)ï¼‰åŸºäºè‡ªå®šä¹‰çš„ExecutorServiceåˆ›å»º Schedulerï¼ˆè™½ç„¶ä¸å¤ªå»ºè®®ï¼Œä¸è¿‡ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Executoræ¥åˆ›å»ºï¼‰ã€‚
Schedulersç±»å·²ç»é¢„å…ˆåˆ›å»ºäº†å‡ ç§å¸¸ç”¨çš„çº¿ç¨‹æ± ï¼šä½¿ç”¨single()ã€elastic()å’Œparallel()æ–¹æ³•å¯ä»¥åˆ†åˆ«ä½¿ç”¨å†…ç½®çš„å•çº¿ç¨‹ã€å¼¹æ€§çº¿ç¨‹æ± å’Œå›ºå®šå¤§å°çº¿ç¨‹æ± ã€‚å¦‚æœæƒ³åˆ›å»ºæ–°çš„çº¿ç¨‹æ± ï¼Œå¯ä»¥ä½¿ç”¨newSingle()ã€newElastic()å’ŒnewParallel()æ–¹æ³•ã€‚

Executorsæä¾›çš„å‡ ç§çº¿ç¨‹æ± åœ¨Reactorä¸­éƒ½æ”¯æŒï¼š
```
Schedulers.single()å’ŒSchedulers.newSingle()å¯¹åº”Executors.newSingleThreadExecutor()ï¼›
Schedulers.elastic()å’ŒSchedulers.newElastic()å¯¹åº”Executors.newCachedThreadPool()ï¼›
Schedulers.parallel()å’ŒSchedulers.newParallel()å¯¹åº”Executors.newFixedThreadPool()ï¼›
```

Schedulersæä¾›çš„ä»¥ä¸Šä¸‰ç§è°ƒåº¦å™¨åº•å±‚éƒ½æ˜¯åŸºäºScheduledExecutorServiceçš„ï¼Œå› æ­¤éƒ½æ˜¯æ”¯æŒä»»åŠ¡å®šæ—¶å’Œå‘¨æœŸæ€§æ‰§è¡Œçš„ï¼›
Fluxå’ŒMonoçš„è°ƒåº¦æ“ä½œç¬¦subscribeOnå’ŒpublishOnæ”¯æŒwork-stealingã€‚

 
æœ€æ–°ç‰ˆæœ¬ä¸­elasticè¢«åºŸå¼ƒäº†ï¼Œé‡æ–°æä¾›äº†boundedElasticã€‚

Schedulers#boundedElastic

public static Scheduler boundedElastic() {
	return cache(CACHED_BOUNDED_ELASTIC, BOUNDED_ELASTIC, BOUNDED_ELASTIC_SUPPLIER);
}

static final Supplier<Scheduler> BOUNDED_ELASTIC_SUPPLIER =
		() -> newBoundedElastic(DEFAULT_BOUNDED_ELASTIC_SIZE, DEFAULT_BOUNDED_ELASTIC_QUEUESIZE,
				BOUNDED_ELASTIC, BoundedElasticScheduler.DEFAULT_TTL_SECONDS, true);
DEFAULT_BOUNDED_ELASTIC_SIZEè¡¨ç¤ºå…¨å±€bounddElasticï¼ˆï¼‰è°ƒåº¦å™¨çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ŒDEFAULT_BOUNDED_ELASTIC_SIZEç”±å±æ€§reactor.schedulers.defaultBoundedElasticSizeè®¾ç½®ï¼Œè‹¥æœªè®¾ç½®åˆ™åˆå§‹åŒ–ä¸º10å€å¤„ç†å™¨æ•°ã€‚
 
DEFAULT_BOUNDED_ELASTIC_QUEUESIZEè¡¨ç¤ºå…¨å±€bounddElasticï¼ˆï¼‰è°ƒåº¦å™¨çš„æ— æ³•åˆ›å»ºæ›´å¤šçº¿ç¨‹æ—¶è¦æ’é˜Ÿçš„æœ€å¤§ä»»åŠ¡æ•°ã€‚DEFAULT_BOUNDED_ELASTIC_QUEUESIZEç”±å±æ€§reactor.schedulers.defaultBoundedElasticQueueSizeè®¾ç½®ï¼Œè‹¥æœªè®¾ç½®åˆ™åˆå§‹åŒ–ä¸º100000ã€‚

publishOn å’Œ subscribeOn
publishOn å’Œ subscribeOnéƒ½æ˜¯åœ¨æŒ‡å®šçš„Schedulerä¸­è¿è¡Œã€‚å½“æŸäº›æ“ä½œæ‰§è¡Œæ…¢ï¼Œé˜»ç¢è¿è¡Œé€Ÿåº¦æ—¶å¯ä»¥åœ¨æŒ‡å®šçš„Schedulerä¸­æ‰§è¡Œã€‚
```
@Test
public void testPublishOn() {
    Flux.just("tom")
            .map(s -> {
                System.out.println("[map] Thread name: " + Thread.currentThread().getName());
                return s.concat("@mail.com");
            })
            .publishOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-publishOn"))
            .filter(s -> {
                System.out.println("[filter] Thread name: " + Thread.currentThread().getName());
                return s.startsWith("t");
            })
            .doOnNext((t) -> {
                System.out.println("[ doOnNext ] Thread name:" + Thread.currentThread().getName());
            })
            .subscribeOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-subscribeOn"))
            .subscribe(s -> {
                System.out.println("[subscribe] Thread name: " + Thread.currentThread().getName());
                System.out.println(s);
            });
}

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

[map] Thread name: thread-subscribeOn-1
[filter] Thread name: thread-publishOn-2
[ doOnNext ] Thread name:thread-publishOn-2
[subscribe] Thread name: thread-publishOn-2
tom@mail.com
```
å¯ä»¥çœ‹åˆ°mapæ“ä½œåœ¨subscribeOnè®¾ç½®çš„Schedulersä¸­è¿è¡Œï¼Œä»publishOnä»¥åéƒ½æ˜¯åœ¨publishOnè®¾ç½®çš„Schedulersä¸­è¿è¡Œï¼Œå³ä½¿æ˜¯subscribeOnæ“ä½œåé¢çš„æ“ä½œã€‚ä»ä¸Šé¢å¯çŸ¥subscribeOnä»å¼€å¤´å¼€å§‹å½±å“æ“ä½œæ‰€åœ¨çš„çº¿ç¨‹ï¼Œä»publishOnæ“ä½œä¹‹åæ‰€æœ‰çš„æ“ä½œéƒ½åœ¨publishOnè®¾ç½®çš„Schedulersä¸­è¿è¡Œã€‚

```
@Test
public void testPublishOn1() {
    Flux.just("tom")
            .map(s -> {
                System.out.println("[map] Thread name: " + Thread.currentThread().getName());
                return s.concat("@mail.com");
            })
            .publishOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-publishOn"))
            .filter(s -> {
                System.out.println("[filter] Thread name: " + Thread.currentThread().getName());
                return s.startsWith("t");
            })
            .doOnNext((t) -> {
                System.out.println("[ doOnNext ] Thread name:" + Thread.currentThread().getName());
            })
            .subscribeOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-subscribeOn"))
            .doOnNext((t) -> {
                System.out.println("[ doOnNext1 ] Thread name:" + Thread.currentThread().getName());
            })
            .subscribeOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-000"))
            .doOnNext((t) -> {
                System.out.println("[ doOnNext2 ] Thread name:" + Thread.currentThread().getName());
            })
            .subscribe(s -> {
                System.out.println("[subscribe] Thread name: " + Thread.currentThread().getName());
                System.out.println(s);
            });
}
æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

[map] Thread name: thread-subscribeOn-2
[filter] Thread name: thread-publishOn-3
[ doOnNext ] Thread name:thread-publishOn-3
[ doOnNext1 ] Thread name:thread-publishOn-3
[ doOnNext2 ] Thread name:thread-publishOn-3
[subscribe] Thread name: thread-publishOn-3
tom@mail.com
ç¬¬äºŒä¸ªsubscribeOnä¸èµ·ä½œç”¨ã€‚åªæœ‰ç¬¬ä¸€ä¸ªsubscribeOnæ‰æœ‰ä½œç”¨ã€‚
```
```
@Test
public void testPublishOn3() {
    Flux.just("tom")
            .publishOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-publishOn"))
            .doOnNext((t) -> {
                System.out.println("[ doOnNext ] Thread name:" + Thread.currentThread().getName());
            })
            .publishOn(Schedulers.newBoundedElastic(Runtime.getRuntime().availableProcessors(), 1000,"thread-publishOn000"))
            .doOnNext((t) -> {
                System.out.println("[ doOnNext1 ] Thread name:" + Thread.currentThread().getName());
            })
            .subscribe(s -> {
                System.out.println("[subscribe] Thread name: " + Thread.currentThread().getName());
                System.out.println(s);
            });
}
æ‰§è¡Œç»“æœï¼š

[ doOnNext ] Thread name:thread-publishOn-2
[ doOnNext1 ] Thread name:thread-publishOn000-1
[subscribe] Thread name: thread-publishOn000-1
tom
ç¬¬äºŒä¸ªpublishOnä¼šå½±å“ç¬¬ä¸€ä¸ªpublishOnã€‚

 ```